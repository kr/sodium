#!/usr/bin/env python2.5

import sys
from getopt import getopt

from pair import cons, nil
import reader
import lx

def basename(name):
  return name[:name.find('.')]

def read_file(n):
    return reader.read(open(n).read(), n)

opts, args = getopt(sys.argv[1:], 'mco:t:', [
        'module',
        'generate-c',
        'output=',
        'mtab=',
        ])

infile = args[0]
outfile = infile + 'c'
gen_c = False
module = False
mtab = None

for opt, val in opts:
    if opt in ('--generate-c', '-c'):
        gen_c = True
    elif opt in ('--module', '-m'):
        module = True
    elif opt in ('--output', '-o'):
        outfile = val
    elif opt in ('--mtab', '-t'):
        mtab = val

if len(sys.argv) < 2:
    print 'please give me a flie'
    sys.exit()

exps = read_file(infile)
if module:
    # ((fn () ...))
    exp = cons(cons(lx.fn_s, cons(nil, exps)), nil)
else:
    # (do ...)
    exp = cons(lx.do_s, exps)

code = lx.compile(exp, lx.S('val'), lx.S('next'), nil, lx.S('pop-all-top'))
outfd = open(outfile, 'w')
if gen_c:
    if not outfile.endswith('.c'): raise 'bad output file name', outfile
    code.gen_c(basename(infile), outfd, mtab=mtab)
else:
    code.assemble(outfd)
