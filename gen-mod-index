#!/usr/bin/env python

import sys
from getopt import getopt
from re import match

def tr(s, old, new):
    for a,b in zip(old, new):
        s = s.replace(a, b)
    return s

opts, args = getopt(sys.argv[1:], 'o:', [
        'output=',
        ])

outfile = 'index.c'

for opt, val in opts:
    if opt in ('--output', '-o'):
        outfile = val

if not outfile.endswith('.c'):
    outfile = outfile + '.c'

lxmodules = []
for arg in args:
    lxmodules.append(arg)

count = len(lxmodules)

outfd = open(outfile, 'w')

print >>outfd, '/* This file is automatically generated. */'
print >>outfd
print >>outfd, '#include "lxc.h"'
print >>outfd, '#include "module-index.h"'
#print >>outfd, 'extern struct lxc_module lxc_module_prelude;'
for module in lxmodules:
  module = tr(module, '/-.', '___')
  if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
  print >>outfd, 'extern struct lxc_module lxc_module_%s;' % (module,)

print >>outfd

print >>outfd, 'int lxc_modules_count = %d;' % (count,)

print >>outfd, 'lxc_module lxc_modules[%d] = {' % (count,)
#print >>outfd, '    &lxc_module_prelude,'
for module in lxmodules:
    module = tr(module, '/-.', '___')
    if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
    print >>outfd, '    &lxc_module_%s,' % (module,)
print >>outfd, '};'

