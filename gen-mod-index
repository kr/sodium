#!/usr/bin/env python


import sys
from getopt import getopt
from re import match

def tr(s, old, new):
    for a,b in zip(old, new):
        s = s.replace(a, b)
    return s

opts, args = getopt(sys.argv[1:], 'o:', [
        'output=',
        ])

outfile = 'index.c'

for opt, val in opts:
    if opt in ('--output', '-o'):
        outfile = val

if not outfile.endswith('.c'):
    outfile = outfile + '.c'

lxmodules = []
lxcmodules = None
for arg in args:
    if lxcmodules is None:
        if arg == '--':
            lxcmodules = []
        else:
            lxmodules.append(arg)
    else:
        lxcmodules.append(arg)

count = len(lxcmodules) + len(lxmodules) + 1

outfd = open(outfile, 'w')

print >>outfd, '/* This file is automatically generated. */'
print >>outfd
print >>outfd, '#include "lxc.h"'
print >>outfd, '#include "module-index.h"'
print >>outfd, '#include "prelude.h"'
for module in lxcmodules:
    print >>outfd, '#include "%s.h"' % (module,)
for module in lxmodules:
    print >>outfd, '#include "%s.lxc.h"' % (module,)

print >>outfd

print >>outfd, 'int lxc_modules_count = %d;' % (count,)

print >>outfd, 'lxc_module lxc_modules[%d] = {' % (count,)
print >>outfd, '    &lxc_module_prelude,'
for module in lxcmodules:
    module = tr(module, '/-', '__')
    if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
    print >>outfd, '    &lxc_module_%s,' % (module,)
for module in lxmodules:
    module = tr(module, '/-', '__')
    if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
    print >>outfd, '    &lxc_module_%s,' % (module,)
print >>outfd, '};'

