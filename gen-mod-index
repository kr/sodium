#!/usr/bin/env python

import sys
from getopt import getopt
from re import match

def tr(s, old, new):
    for a,b in zip(old, new):
        s = s.replace(a, b)
    return s

opts, args = getopt(sys.argv[1:], 'o:', [
        'output=',
        ])

outfile = 'index.c'

for opt, val in opts:
    if opt in ('--output', '-o'):
        outfile = val

modules = []
for arg in args:
    modules.append(arg)

outfd = open(outfile, 'w')

print >>outfd, '/* This file is automatically generated. */'
print >>outfd
print >>outfd, '#include "lxc.h"'
print >>outfd, '#include "index.h"'
for module in modules:
  module = tr(module, '/-.', '___')
  if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
  print >>outfd, 'extern struct lxc_module lxc_module_%s;' % (module,)

print >>outfd

print >>outfd, 'lxc_module lxc_modules[%d] = {' % (len(modules) + 1)
#print >>outfd, '    &lxc_module_prelude,'
for module in modules:
    module = tr(module, '/-.', '___')
    if match('.*[^-_/A-Za-z0-9]', module): raise 'bad module name', module
    print >>outfd, '    &lxc_module_%s,' % (module,)
print >>outfd, '    0,'
print >>outfd, '};'

